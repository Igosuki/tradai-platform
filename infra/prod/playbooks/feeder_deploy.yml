---
- hosts: "{{ INVENTORY_HOST }}"
  name: Deploy the feeder
  remote_user: root
  pre_tasks:
    - name: Configuration
      copy:
        src: ./trader_conf/
        dest: /root/config
        owner: root
        group: root
        mode: '0644'
    - name: Trader Binary
      copy:
        src: ../../../cargo-target/x86_64-unknown-linux-gnu/release/trader
        dest: /root/feeder.staged
        owner: root
        group: root
        mode: '+x'
  tasks:
    - name: backup feeder
      shell: cp feeder "feeder.bak.$(date +%F)"
      args:
        chdir: /root/
      ignore_errors: yes
    - name: restart feeder
      shell: systemctl stop feeder && cp feeder.staged feeder && systemctl start feeder
      args:
        chdir: /root/
    - name: start cloner service
      shell: systemctl enable cloner.service
    - name: start cloner timer
      systemd: state=started name=cloner.timer daemon_reload=yes
